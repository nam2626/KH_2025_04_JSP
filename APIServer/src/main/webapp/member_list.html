<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script>
	function allMember() {
		fetch('./members')
		.then(result => {
			return result.json();
		})
		.then(data => {
			console.log(data);
			let tag = '';
			data.list.forEach(item => {
				tag += `
					<tr>
						<td><input type='text' value='${item.id}' readonly></td>
						<td class='passwd'><input type='text' value='${item.passwd}'></td>
						<td><input type='text' value='${item.userName}'></td>
						<td><input type='text' value='${item.nickName}'></td>
						<td><a class='btn_delete'>삭제</a> / <a class='btn_update'>수정</a></td>
					</tr>`;
			});
			tag = `<table>
				<tr>
					<th>아이디</th>
					<th class='passwd'>암호</th>
					<th>이름</th>
					<th>닉네임</th>
					<th>비고</th>
				</tr>${tag}</table>`;
			document.querySelector('#area').innerHTML = tag;
			//------------------------------------------------
			// 동적 엘리먼트 처리
			//   새로 태그가 만들어지면 기존에 설정했던 이벤트가 적용 되지 않음
			//	 태그가 새로 출력이 된 다음에 이벤트를 다시 지정을 해야됨
			document.querySelectorAll('.btn_delete').forEach(item => {
				item.onclick = (e) => {
					//삭제를 클릭한 아이디값
					console.log(e.target.parentNode.parentNode
							.firstElementChild.innerText);
					deleteMember(e.target.parentNode.parentNode
							.firstElementChild.innerText)
				}
			}) 
		})
	}
	async function deleteMember(id) {
		try {
			const response = await fetch(`./members/${id}`,{
				method : 'DELETE'
			});
			const data = await response.json();
			console.log(data);
			if(response.ok){
				alert(data.message);
				allMember();
			}
		} catch (error) {
			console.log(error);
		}
		
	}	
	async function insertMember() {
		const formData = {};
		
		const fields = document.querySelectorAll('.frm_insert > input');
		fields.forEach((item) => {
			formData[item.id] = item.value;
		});
		console.log(formData);
		try{
			const response = await fetch('./members',{
				method : 'POST',
				headers:{
					'Content-Type' : 'application/json',
					'Accept' : 'application/json'
				},
				body: JSON.stringify(formData)
			});
			const data = await response.json();
			//데이터 결과를 출력
			console.log(data);
			if(data.count == 1)
				allMember();
		}catch(error){
			console.log(error);
		}
	}
	window.onload = () => {
		allMember();
		document.querySelector('.btn_register').onclick = insertMember;
		document.querySelectorAll('.btn_delete').forEach(item => {
			item.onclick = (e) => {
				console.log(e.target.parentNode.parentNode);
			}
		}) 
	}
</script>
<style>
	table{
		margin: 0 auto;
		border-collapse: collapse;
		table-layout: fixed;
		width: 1000px;
	}	
	td,th{
		border: 1px solid black;
		padding: 10px;
		text-align: center;
	}
	.frm_insert{
		text-align: center;
	}
	.passwd{
		width: 400px;
		overflow: hidden;
		text-overflow: ellipsis;
		white-space: nowrap;
	}
</style>
</head>
<body>
	<!-- 회원정보 추가하는 폼 -->
	<div class="frm_insert">
		<input type="text" id="id" placeholder="아이디 입력">
		<input type="password" id="passwd" placeholder="암호 입력">
		<input type="text" id="userName" placeholder="사용자 이름 입력">
		<input type="text" id="nickName" placeholder="사용자 닉네임 입력">
		<button type="button" class="btn_register">등록</button>
	</div>
	<hr>
	<div id="area"></div>
</body>
</html>




